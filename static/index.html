<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management - MVP</title>
    <link rel="stylesheet" href="mystyle.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alpinejs/3.13.0/cdn.js" defer></script>
    <script src="script.js"></script>
</head>
<body>
    <div x-data="inventoryApp()" x-init="checkAuth()">
        <div 
            x-show="error"
            x-transition
            x-text="error"
            class="error"
            x-init="$watch('error', val => { if(val) setTimeout(() => error = '', 5000) })">
        </div>
    <div x-data="inventoryApp()" x-init="checkAuth()">
        <!-- Login Screen -->
        <div x-show="!isAuthenticated" class="card">
            <form @submit.prevent="login()" class="login-form">
                <div class="card-header">
                <h2>Inventory Management</h2>
                </div>
                <!-- <div class="demo-credentials">
                    <strong>Demo Credentials:</strong><br>
                    Engineer: john@company.com / password123<br>
                    Admin: admin@company.com / admin123
                </div> -->
                
                <div x-show="error" class="error" x-text="error"></div>
                <div class="card-body">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" x-model="loginForm.email" required>
                </div>
                
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" x-model="loginForm.password" required>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;" :disabled="loading">
                    <span x-show="!loading">Login</span>
                    <span x-show="loading">Logging in...</span>
                </button>
            </form>
            <div class="back-link" style="margin-top: 1rem; text-align: center;">
                <a href="/static/forgot_password.html">Forgot Password?</a>
            </div>
            </div>
        </div>

        <!-- Main App -->
        <div x-data="{}" x-show="isAuthenticated" class="container">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <div>
                        <h1>Inventory Management</h1>
                        <p>Welcome back, <strong x-text="currentUser?.name"></strong> (<span x-text="currentUser?.role"></span>)</p>
                    </div>
                    <div class="controls" style="margin-bottom: 1.5rem;">
                            <button class="btn" @click="logout()">Logout</button>
                            <button class="btn" @click="window.location.href='/static/profile.html'">Profile</button></a>
                            
                </div>
            </div>

            <!-- Loading State -->
            <div x-show="loading" class="loading">
                <div>Loading inventory data...</div>
            </div>

            <!-- Quick Stats -->
            <div x-show="!loading" class="stats">
                <div class="stat-card" @click="openPanel('showAllPartsPanel')" style="cursor: pointer;">
                    <div class="stat-number" x-text="stats.total_parts || 0"></div>
                    <div>Total Parts</div>
                </div>
                <div class="stat-card" @click="openPanel('showAllStoresPanel')" style="cursor: pointer;">
                    <div class="stat-number" x-text="stats.total_stores || 0"></div>
                    <div>Active Stores</div>
                </div>
                <div class="stat-card" @click="openPanel('showEquipmentPanel')" style="cursor: pointer;">
                    <div class="stat-number" x-text="equipmentStats.my_equipment || 0"></div>
                    <div>My Equipment</div>
                </div>
                <div class="stat-card" @click="openPanel('showMyPartsPanel')" style="cursor: pointer;">
                    <div class="stat-number" x-text="stats.my_parts || 0"></div>
                    <div>My Parts</div>
                </div>
            </div>

            <!-- Controls -->
            <div x-show="!loading" class="controls">
                <div class="control-row">
                    <input type="text" 
                           placeholder="Search parts..." 
                           class="search-box"
                           x-model="searchTerm"
                           @input="console.log('Search input:', searchTerm); filterInventory()"
                           @keyup="console.log('Search keyup:', searchTerm); filterInventory()">
                    
                    <select x-model="storeFilter" @change="filterInventory()">
                        <option value="">All Stores</option>
                        <template x-for="store in stores" :key="store.id">
                            <option :value="store.id" x-text="store.name"></option>
                        </template>
                    </select>
                    
                    <button class="btn btn-success" @click="showAddModal = true">Add Stock</button>

                    <!-- UPDATED: Export dropdown button -->
                    <div style="position: relative;" x-data="{ showExportMenu: false }">
                        <button class="btn" @click="showExportMenu = !showExportMenu">
                            Export CSV ‚ñº
                        </button>
                        <div x-show="showExportMenu" 
                            @click.outside="showExportMenu = false"
                            style="position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd; border-radius: 4px; margin-top: 4px; min-width: 200px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 1000;">
                            <button class="btn" style="width: 100%; text-align: left; border-radius: 0; border: none; border-bottom: 1px solid #eee;" 
                                    @click="exportInventoryCSV(); showExportMenu = false">
                                Current View
                            </button>
                            <button class="btn" style="width: 100%; text-align: left; border-radius: 0; border: none; border-bottom: 1px solid #eee;" 
                                    @click="exportAllPartsCSV(); showExportMenu = false">
                                All Parts Catalog
                            </button>
                            <button class="btn" style="width: 100%; text-align: left; border-radius: 0; border: none; border-bottom: 1px solid #eee;" 
                                    @click="exportStoresCSV(); showExportMenu = false">
                                All Stores
                            </button>
                            <button class="btn" style="width: 100%; text-align: left; border-radius: 0; border: none; border-bottom: 1px solid #eee;" 
                                    @click="exportMovementsCSV(); showExportMenu = false">
                                Movement History
                            </button>
                            <button class="btn btn-success" style="width: 100%; text-align: left; border-radius: 0; border: none;" 
                                    @click="exportComprehensiveReport(); showExportMenu = false">
                                üìä Comprehensive Report
                            </button>
                            
                        </div>
                    </div>

                    <!-- <button class="btn" @click="exportCSV()">Export Inventory</button> -->
                    <button x-show="currentUser?.role === 'admin'" class="btn" @click="openPanel('showUsersPanel')">
                        <span>Manage Users</span>
                    </button>
                    <button x-show="currentUser?.role === 'admin'" class="btn" @click="openPanel('showStoresPanel'); if(users.length === 0) loadUsers()">
                        <span>Manage Stores</span>
                    </button>
                    <button x-show="currentUser?.role === 'admin'" class="btn" @click="openPanel('showPartsPanel')">
                        <span>Manage Parts</span>
                    </button>
                    <button class="btn" @click="openPanel('showEquipmentPanel'); loadEquipment()">
                        <span>Equipment</span>
                    </button>
                    <button x-show="currentUser?.role === 'admin'" class="btn" 
                            @click="showCalibrationSettingsModal = true; loadCalibrationSettings()">
                        <span>Calibration Settings</span>
                    </button>
                    <button class="btn" @click="openPanel('showMovementsPanel'); loadMovements()">
                        <span>Movement History</span>
                    </button>
          
                </div>
                
                <div x-show="error" class="error" x-text="error"></div>
                <div x-show="successMessage" class="success" x-text="successMessage"></div>
            </div>

            <!-- All Parts Panel -->
            <div x-show="showAllPartsPanel" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">All Parts Catalog</h3>
                    <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Unit Cost</th>
                            <th>Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="part in allPartsView" :key="part.id">
                            <tr>
                                <td><strong x-text="part.part_number"></strong></td>
                                <td x-text="part.description"></td>
                                <td><span class="wo-tag" x-text="part.category"></span></td>
                                <td x-text="part.unit_cost"></td>
                                <td x-text="inventory.filter(i => i.part_number === part.part_number).reduce((sum, i) => sum + i.quantity, 0)"></td>
                            </tr>
            <div x-show="!loading && showUsersPanel && currentUser?.role === 'admin'" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">User Management</h3>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-success" @click="editingUser = null; userForm = { email: '', name: '', password: '', role: 'engineer', territory: '' }; showUserModal = true">
            Add User
        </button>
    </div>
</div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Territory</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="user in users" :key="user.id">
                            <tr>
                                <td x-text="user.name"></td>
                                <td x-text="user.email"></td>
                                <td>
                                    <span class="wo-tag" x-text="user.role"></span>
                                </td>
                                <td x-text="user.territory || 'N/A'"></td>
                                <td>
                                    <button class="btn btn-sm" @click="editUser(user)">Edit</button>
                                    <button class="btn btn-sm" 
                                            style="background: #dc3545; color: white;"
                                            x-show="user.id !== currentUser.id"
                                            @click="deleteUser(user.id, user.name)">Delete</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Store Management Panel (Admin Only) -->
            <div x-show="!loading && showStoresPanel && currentUser?.role === 'admin'" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                    <h3 style="margin: 0;">Store Management</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-sm" @click="downloadStoreTemplate()">Download Template</button>
                        <label class="btn btn-sm" style="cursor: pointer;">
                            Import CSV
                            <input type="file" accept=".csv" @change="importStores($event)" style="display: none;">
                        </label>
                        <button class="btn btn-success" 
                                @click="editingStore = null; storeForm = { name: '', type: 'customer_site', location: '', assigned_user_id: '' }; showStoreModal = true">
                            Add Store
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="store in stores" :key="store.id">
                            <tr>
                                <td x-text="store.name"></td>
                                <td>
                                    <span class="wo-tag" x-text="store.type"></span>
                                </td>
                                <td x-text="store.location || 'N/A'"></td>
                                <td x-text="getUserName(store.assigned_user_id)"></td>
                                <td>
                                    <button class="btn btn-sm" @click="editStore(store)">Edit</button>
                                    <button class="btn btn-sm" 
                                            style="background: #dc3545; color: white;"
                                            @click="deleteStore(store.id, store.name)">Delete</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Parts Management Panel (Admin Only) -->
            <div x-show="!loading && showPartsPanel && currentUser?.role === 'admin'" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                    <h3 style="margin: 0;">Parts Management</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-sm" @click="downloadPartTemplate()">Download Template</button>
                        <label class="btn btn-sm" style="cursor: pointer;">
                            Import CSV
                            <input type="file" accept=".csv" @change="importParts($event)" style="display: none;">
                        </label>
                        <button class="btn btn-success" 
                                @click="editingPart = null; partForm = { part_number: '', description: '', category: '', unit_cost: '' }; 653 = true">
                            Add Part
                        </button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Unit Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="part in parts" :key="part.id">
                            <tr>
                                <td><strong x-text="part.part_number"></strong></td>
                                <td x-text="part.description"></td>
                                <td>
                                    <span class="wo-tag" x-text="part.category"></span>
                                </td>
                                <td x-text="part.unit_cost ? part.unit_cost.toFixed(2) : '0.00'"></td>
                                <td>
                                    <button class="btn btn-sm" @click="editPart(part)">Edit</button>
                                    <button class="btn btn-sm" 
                                            style="background: #dc3545; color: white;"
                                            @click="deletePart(part.id, part.part_number)">Delete</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

        <!-- Equipment Management Panel -->
<div x-show="!loading && showEquipmentPanel" class="inventory-table" style="margin-bottom: 1.5rem;">
    <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
        <div>
            <h3 style="margin: 0;">Equipment Management</h3>
            <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem;">
                <span>Total: <strong x-text="equipmentStats.total_equipment || 0"></strong></span>
                <span>Mine: <strong x-text="equipmentStats.my_equipment || 0"></strong></span>
                <span style="color: #f59e0b;">Due Soon: <strong x-text="equipmentStats.due_soon || 0"></strong></span>
                <span style="color: #dc2626;">Overdue: <strong x-text="equipmentStats.overdue || 0"></strong></span>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-sm" @click="downloadEquipmentTemplate()">Download Template</button>
            <button class="btn btn-sm btn-success" @click="exportEquipmentCSV()">Export CSV</button>
            <button x-show="currentUser?.role === 'admin'" class="btn btn-success" 
                    @click="editingEquipment = null; equipmentForm = { equipment_name: '', make: '', model: '', serial_number: '', assigned_user_id: '', calibration_cert_number: '', calibration_authority: '', calibration_date: '', next_calibration_date: '', notes: '' }; showEquipmentModal = true">
                Add Equipment
            </button>
            <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>Equipment Name</th>
                <th>Make/Model</th>
                <th>Serial #</th>
                <th>Assigned To</th>
                <th>Last Calibration</th>
                <th>Next Calibration</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <template x-for="eq in equipment" :key="eq.id">
                <tr :class="getCalibrationStatus(eq).class">
                    <td><strong x-text="eq.equipment_name"></strong></td>
                    <td x-text="`${eq.make} ${eq.model}`"></td>
                    <td x-text="eq.serial_number" style="font-family: monospace; font-size: 0.9em;"></td>
                    <td>
                        <span class="wo-tag" x-text="eq.assigned_user_name || 'Unassigned'"></span>
                    </td>
                    <td x-text="eq.calibration_date ? new Date(eq.calibration_date).toLocaleDateString() : '-'"></td>
                    <td x-text="eq.next_calibration_date ? new Date(eq.next_calibration_date).toLocaleDateString() : '-'"></td>
                    <td>
                        <span class="wo-tag" 
                              :style="`background: ${getCalibrationStatus(eq).status === 'overdue' ? '#fee2e2' : getCalibrationStatus(eq).status === 'urgent' ? '#fed7aa' : getCalibrationStatus(eq).status === 'soon' ? '#fef3c7' : '#d1fae5'}; color: ${getCalibrationStatus(eq).status === 'overdue' ? '#991b1b' : getCalibrationStatus(eq).status === 'urgent' ? '#9a3412' : getCalibrationStatus(eq).status === 'soon' ? '#92400e' : '#065f46'};`"
                              x-text="getCalibrationStatus(eq).text">
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm" 
                                @click="openCalibrationModal(eq)"
                                x-show="currentUser?.role === 'admin' || eq.assigned_user_id === currentUser?.id">
                            Calibrate
                        </button>
                        <button class="btn btn-sm" 
                                @click="openTransferEquipmentModal(eq)"
                                x-show="currentUser?.role === 'admin' || eq.assigned_user_id === currentUser?.id">
                            Transfer
                        </button>
                        <button class="btn btn-sm" @click="viewEquipmentHistory(eq)">History</button>
                        <button class="btn btn-sm" 
                                x-show="currentUser?.role === 'admin'"
                                @click="editEquipment(eq)">
                            Edit
                        </button>
                        <button class="btn btn-sm" 
                                style="background: #dc3545; color: white;"
                                x-show="currentUser?.role === 'admin'"
                                @click="deleteEquipment(eq.id, eq.equipment_name)">
                            Delete
                        </button>
                    </td>
                </tr>
            </template>
        </tbody>
    </table>
    
    <div x-show="equipment.length === 0" style="padding: 2rem; text-align: center; color: #666;">
        No equipment found.
    </div>
</div>

            <!-- Recent Activity Feed (Home View) -->
            <div x-show="!loading && !showUsersPanel && !showStoresPanel && !showPartsPanel && !showMovementsPanel && !showAllPartsPanel && !showAllStoresPanel && !showLowStockPanel && !showMyPartsPanel && !showStoreInventoryPanel" class="inventory-table">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0;">Recent Activity</h3>
                    <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;">
                        <span x-show="currentUser?.role === 'admin'">Showing all recent inventory movements</span>
                        <span x-show="currentUser?.role !== 'admin'">Showing your recent activity</span>
                    </p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Action</th>
                            <th>Part</th>
                            <th>Qty</th>
                            <th>From/To</th>
                            <th>By</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="activity in recentActivity" :key="activity.id">
                            <tr>
                                <td x-text="new Date(activity.created_at).toLocaleString('en-US', {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})"></td>
                                <td>
                                    <span class="wo-tag" x-text="activity.movement_type"></span>
                                </td>
                                <td><strong x-text="activity.part_number"></strong></td>
                                <td x-text="activity.quantity"></td>
                                <td>
                                    <span x-show="activity.from_store_name" x-text="activity.from_store_name"></span>
                                    <span x-show="activity.from_store_name && activity.to_store_name"> ‚Üí </span>
                                    <span x-show="activity.to_store_name" x-text="activity.to_store_name"></span>
                                    <span x-show="!activity.from_store_name && !activity.to_store_name">-</span>
                                </td>
                                <td x-text="activity.created_by_name"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="recentActivity.length === 0" style="padding: 2rem; text-align: center; color: #666;">
                    No recent activity. Start by adding or transferring inventory!
                </div>
            </div>
            <div x-show="showInventoryPanel" class="inventory-table">
                <table>
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Store</th>
                            <th>Quantity</th>
                            <th>Work Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in filteredInventory" :key="item.id">
                            <tr :class="item.quantity <= item.min_threshold ? 'low-stock' : ''">
                                <td x-text="item.part_number"></td>
                                <td x-text="item.description"></td>
                                <td>
                                    <span class="store-tag" 
                                          :class="getStoreClass(item.store_type, item.store_owner)"
                                          x-text="item.store_name">
                                    </span>
                                </td>
                                <td>
                                    <strong x-text="item.quantity"></strong>
                                    <span x-show="item.quantity <= item.min_threshold">‚ö†Ô∏è</span>
                                </td>
                                <td>
                                    <span x-show="item.work_order" 
                                          class="wo-tag" 
                                          x-text="item.work_order">
                                    </span>
                                    <span x-show="!item.work_order" class="wo-tag">Original</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm" 
                                            x-show="canEdit(item.store_owner, item.store_type)"
                                            @click="editItem(item)">
                                        Edit
                                    </button>
                                    <button class="btn btn-sm btn-warning" 
                                            x-show="canEdit(item.store_owner, item.store_type)"
                                            @click="transferItem(item)">
                                        Transfer
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                
                <div x-show="filteredInventory.length === 0" style="padding: 2rem; text-align: center; color: #666;">
                    No inventory found matching your search criteria.
                </div>
            </div>

            <!-- some profile thing -->
             
            <!-- --------------------------- -->

            <!-- ALL MODALS -->

            <!-- Activity Stats Modal -->
<div x-show="showStatsModal" class="modal" @click.outside="showStatsModal = false">
    <div class="modal-content" style="max-width: 800px;">
        <h3>Activity Statistics</h3>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1.5rem 0;">
            <div class="stat-card">
                <div class="stat-number" x-text="activityStats.total_activities || 0"></div>
                <div>Total Activities</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" x-text="activityStats.error_rate?.errors || 0"></div>
                <div>Errors</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" x-text="activityStats.error_rate?.successes || 0"></div>
                <div>Successes</div>
            </div>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <h4>Top Actions</h4>
            <table style="margin-top: 0.5rem;">
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="item in activityStats.by_action" :key="item.action">
                        <tr>
                            <td x-text="item.action.replace('_', ' ')"></td>
                            <td><strong x-text="item.count"></strong></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <h4>Top Users</h4>
            <table style="margin-top: 0.5rem;">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Activities</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="item in activityStats.by_user" :key="item.username">
                        <tr>
                            <td x-text="item.username"></td>
                            <td><strong x-text="item.count"></strong></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <h4>Recent Logins</h4>
            <table style="margin-top: 0.5rem;">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Time</th>
                        <th>IP Address</th>
                    </tr>
                </thead>
                <tbody>
                    <template x-for="login in activityStats.recent_logins" :key="login.created_at">
                        <tr>
                            <td x-text="login.username"></td>
                            <td x-text="new Date(login.created_at).toLocaleString()"></td>
                            <td x-text="login.ip_address || '-'"></td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
        
        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button type="button" class="btn" @click="showStatsModal = false">Close</button>
        </div>
    </div>
</div>

<!-- Equipment Modal -->
<div x-show="showEquipmentModal" class="modal" @click.outside="showEquipmentModal = false">
    <div class="modal-content" style="max-width: 600px;">
        <h3 x-text="editingEquipment ? 'Edit Equipment' : 'Add New Equipment'"></h3>
        <form @submit.prevent="editingEquipment ? updateEquipment() : createEquipment()">
            <div class="form-group">
                <label>Equipment Name *</label>
                <input type="text" x-model="equipmentForm.equipment_name" required>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Make *</label>
                    <input type="text" x-model="equipmentForm.make" required>
                </div>
                <div class="form-group">
                    <label>Model *</label>
                    <input type="text" x-model="equipmentForm.model" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Serial Number *</label>
                <input type="text" x-model="equipmentForm.serial_number" required>
            </div>
            
            <div class="form-group">
                <label>Assigned To</label>
                <select x-model="equipmentForm.assigned_user_id">
                    <option value="">Unassigned</option>
                    <template x-for="user in users" :key="user.id">
                        <option :value="user.id" x-text="user.name"></option>
                    </template>
                </select>
            </div>
            
            <hr style="margin: 1.5rem 0; border: none; border-top: 1px solid #e5e7eb;">
            <h4 style="margin-bottom: 1rem; color: #667eea;">Calibration Information</h4>
            
            <div class="form-group">
                <label>Calibration Certificate Number</label>
                <input type="text" x-model="equipmentForm.calibration_cert_number">
            </div>
            
            <div class="form-group">
                <label>Calibration Authority</label>
                <input type="text" x-model="equipmentForm.calibration_authority">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Calibration Date</label>
                    <input type="date" x-model="equipmentForm.calibration_date">
                </div>
                <div class="form-group">
                    <label>Next Calibration Date</label>
                    <input type="date" x-model="equipmentForm.next_calibration_date">
                </div>
            </div>
            
            <div class="form-group">
                <label>Notes</label>
                <textarea x-model="equipmentForm.notes" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" @click="showEquipmentModal = false; editingEquipment = null;">Cancel</button>
                <button type="submit" class="btn btn-success" :disabled="loading">
                    <span x-show="!loading" x-text="editingEquipment ? 'Update Equipment' : 'Create Equipment'"></span>
                    <span x-show="loading">Saving...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Calibration Update Modal -->
<div x-show="showCalibrationModal" class="modal" @click.outside="showCalibrationModal = false">
    <div class="modal-content">
        <h3>Update Calibration</h3>
        <p style="margin-bottom: 1rem; color: #666;">
            <strong x-text="selectedEquipment?.equipment_name"></strong> 
            (<span x-text="selectedEquipment?.serial_number"></span>)
        </p>
        <form @submit.prevent="updateCalibration()">
            <div class="form-group">
                <label>Calibration Certificate Number *</label>
                <input type="text" x-model="calibrationForm.calibration_cert_number" required>
            </div>
            
            <div class="form-group">
                <label>Calibration Authority *</label>
                <input type="text" x-model="calibrationForm.calibration_authority" required>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Calibration Date *</label>
                    <input type="date" x-model="calibrationForm.calibration_date" required>
                </div>
                <div class="form-group">
                    <label>Next Calibration Date *</label>
                    <input type="date" x-model="calibrationForm.next_calibration_date" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Notes</label>
                <textarea x-model="calibrationForm.notes" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" @click="showCalibrationModal = false; selectedEquipment = null;">Cancel</button>
                <button type="submit" class="btn btn-success" :disabled="loading">
                    <span x-show="!loading">Update Calibration</span>
                    <span x-show="loading">Updating...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Transfer Equipment Modal -->
<div x-show="showTransferEquipmentModal" class="modal" @click.outside="showTransferEquipmentModal = false">
    <div class="modal-content">
        <h3>Transfer Equipment</h3>
        <p style="margin-bottom: 1rem; color: #666;">
            <strong x-text="selectedEquipment?.equipment_name"></strong> 
            (<span x-text="selectedEquipment?.serial_number"></span>)
        </p>
        <form @submit.prevent="transferEquipmentToUser()">
            <div class="form-group">
                <label>Transfer To</label>
                <select x-model="transferEquipmentForm.to_user_id" required>
                    <option value="">Select User</option>
                    <template x-for="user in users" :key="user.id">
                        <option :value="user.id" x-text="user.name"></option>
                    </template>
                    <option value="">Unassign (Return to Admin)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Notes</label>
                <textarea x-model="transferEquipmentForm.notes" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" placeholder="Reason for transfer..."></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" @click="showTransferEquipmentModal = false; selectedEquipment = null;">Cancel</button>
                <button type="submit" class="btn btn-warning" :disabled="loading">
                    <span x-show="!loading">Transfer Equipment</span>
                    <span x-show="loading">Transferring...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Equipment History Modal -->
<div x-show="showEquipmentHistoryModal" class="modal" @click.outside="showEquipmentHistoryModal = false">
    <div class="modal-content" style="max-width: 700px;">
        <h3>Equipment History</h3>
        <p style="margin-bottom: 1rem; color: #666;">
            <strong x-text="selectedEquipment?.equipment_name"></strong> 
            (<span x-text="selectedEquipment?.serial_number"></span>)
        </p>
        
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Action</th>
                    <th>Details</th>
                    <th>By</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="history in equipmentHistory" :key="history.id">
                    <tr>
                        <td x-text="new Date(history.created_at).toLocaleString()" style="white-space: nowrap;"></td>
                        <td>
                            <span class="wo-tag" x-text="history.action"></span>
                        </td>
                        <td>
                            <span x-show="history.action === 'transferred'">
                                From: <span x-text="history.from_user_name || 'Unassigned'"></span> ‚Üí 
                                To: <span x-text="history.to_user_name || 'Unassigned'"></span>
                            </span>
                            <span x-show="history.action === 'calibrated'" x-text="history.calibration_date"></span>
                            <div x-show="history.notes" style="font-size: 0.85em; color: #666; margin-top: 0.25rem;" x-text="history.notes"></div>
                        </td>
                        <td x-text="history.created_by_name"></td>
                    </tr>
                </template>
            </tbody>
        </table>
        
        <div x-show="equipmentHistory.length === 0" style="padding: 2rem; text-align: center; color: #666;">
            No history available.
        </div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
            <button type="button" class="btn" @click="showEquipmentHistoryModal = false; selectedEquipment = null;">Close</button>
        </div>
    </div>
</div>

<!-- Calibration Settings Modal -->
<div x-show="showCalibrationSettingsModal" class="modal" @click.outside="showCalibrationSettingsModal = false">
    <div class="modal-content">
        <h3>Calibration Reminder Settings</h3>
        <p style="margin-bottom: 1rem; color: #666;">
            Configure when to send calibration due reminders
        </p>
        <form @submit.prevent="updateCalibrationReminderDays()">
            <div class="form-group">
                <label>Send reminder (days before due date)</label>
                <input type="number" x-model="calibrationReminderDays" min="1" max="365" required>
                <small style="color: #666; display: block; margin-top: 0.5rem;">
                    Equipment due within this many days will trigger email reminders
                </small>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" class="btn" @click="showCalibrationSettingsModal = false">Cancel</button>
                <button type="submit" class="btn btn-success" :disabled="loading">
                    <span x-show="!loading">Save Settings</span>
                    <span x-show="loading">Saving...</span>
                </button>
            </div>
        </form>
    </div>
</div>

             <!-- Profile Modal -->
            <div x-show="showProfileModal" class="modal" @click.outside="showProfileModal = false">
                <div class="modal-content">
                    <h3>Add Stock</h3>
                    <form @submit.prevent="addStock()">
                        <div class="form-group">
                            <label>Part</label>
                            <select x-model="addForm.part_id" required>
                                <option value="">Select Part</option>
                                <template x-for="part in parts" :key="part.id">
                                    <option :value="part.id" x-text="part.part_number + ' - ' + part.description"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Store</label>
                            <select x-model="addForm.store_id" required>
                                <option value="">Select Store</option>
                                <template x-for="store in editableStores" :key="store.id">
                                    <option :value="store.id" x-text="store.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" x-model="addForm.quantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Work Order (leave blank for original stock)</label>
                            <input type="text" x-model="addForm.work_order_number" placeholder="WO-2024-001">
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showAddModal = false">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="addingStock">
                                <span x-show="!addingStock">Add Stock</span>
                                <span x-show="addingStock">Adding...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Add Stock Modal -->
            <div x-show="showAddModal" class="modal" @click.outside="showAddModal = false">
                <div class="modal-content">
                    <h3>Add Stock</h3>
                    <form @submit.prevent="addStock()">
                        <div class="form-group">
                            <label>Part</label>
                            <select x-model="addForm.part_id" required>
                                <option value="">Select Part</option>
                                <template x-for="part in parts" :key="part.id">
                                    <option :value="part.id" x-text="part.part_number + ' - ' + part.description"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Store</label>
                            <select x-model="addForm.store_id" required>
                                <option value="">Select Store</option>
                                <template x-for="store in editableStores" :key="store.id">
                                    <option :value="store.id" x-text="store.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" x-model="addForm.quantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Work Order (leave blank for original stock)</label>
                            <input type="text" x-model="addForm.work_order_number" placeholder="WO-2024-001">
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showAddModal = false">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="addingStock">
                                <span x-show="!addingStock">Add Stock</span>
                                <span x-show="addingStock">Adding...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Stock Modal -->
            <div x-show="showEditModal" class="modal" @click.outside="showEditModal = false">
                <div class="modal-content">
                    <h3>Edit Stock Quantity</h3>
                    <form @submit.prevent="updateStock()">
                        <div class="form-group">
                            <label>New Quantity</label>
                            <input type="number" x-model="editForm.new_quantity" min="0" required>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showEditModal = false">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="loading">
                                <span x-show="!loading">Update</span>
                                <span x-show="loading">Updating...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Transfer Stock Modal -->
            <div x-show="showTransferModal" class="modal" @click.outside="showTransferModal = false">
                <div class="modal-content">
                    <h3>Transfer Stock</h3>
                    <form @submit.prevent="transferStock()">
                        <div class="form-group">
                            <label>Destination Store</label>
                            <select x-model="transferForm.to_store_id" required>
                                <option value="">Select Store</option>
                                <template x-for="store in editableStores" :key="store.id">
                                    <option :value="store.id" x-text="store.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity to Transfer</label>
                            <input type="number" x-model="transferForm.quantity" min="1" required>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showTransferModal = false">Cancel</button>
                            <button type="submit" class="btn btn-warning" :disabled="loading">
                                <span x-show="!loading">Transfer</span>
                                <span x-show="loading">Transferring...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- User Management Modal -->
            <div x-show="showUserModal" class="modal" @click.outside="showUserModal = false">
                <div class="modal-content">
                    <h3 x-text="editingUser ? 'Edit User' : 'Create New User'"></h3>
                    <form @submit.prevent="editingUser ? updateUser() : createUser()">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" x-model="userForm.email" required :disabled="!!editingUser">
                        </div>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" x-model="userForm.name" required>
                        </div>
                        <div class="form-group">
                            <label x-text="editingUser ? 'New Password (leave blank to keep current)' : 'Password'"></label>
                            <input type="password" x-model="userForm.password" :required="!editingUser">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select x-model="userForm.role" required>
                                <option value="engineer">Engineer</option>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Territory</label>
                            <input type="text" x-model="userForm.territory" placeholder="Optional">
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showUserModal = false; editingUser = null;">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="loading">
                                <span x-show="!loading" x-text="editingUser ? 'Update User' : 'Create User'"></span>
                                <span x-show="loading" x-text="editingUser ? 'Updating...' : 'Creating...'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Store Management Modal -->
            <div x-show="showStoreModal" class="modal" @click.outside="showStoreModal = false">
                <div class="modal-content">
                    <h3 x-text="editingStore ? 'Edit Store' : 'Create New Store'"></h3>
                    <form @submit.prevent="editingStore ? updateStore() : createStore()">
                        <div class="form-group">
                            <label>Store Name</label>
                            <input type="text" x-model="storeForm.name" required>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <!-- this should also be moved from hardcode to db -->
                            <select x-model="storeForm.type" required>
                                <option value="office">Office</option>
                                <option value="customer_site">Customer Site</option>
                                <option value="engineer">Engineer Personal</option>
                                <option value="fe_consignment">FE Consignment</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" x-model="storeForm.location" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label>Assigned To</label>
                            <select x-model="storeForm.assigned_user_id">
                                <option value="">None</option>
                                <template x-for="user in users" :key="user.id">
                                    <option :value="user.id" x-text="user.name"></option>
                                </template>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showStoreModal = false; editingStore = null;">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="loading">
                                <span x-show="!loading" x-text="editingStore ? 'Update Store' : 'Create Store'"></span>
                                <span x-show="loading" x-text="editingStore ? 'Updating...' : 'Creating...'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Part Management Modal -->
            <div x-show="showPartModal" class="modal" @click.outside="showPartModal = false">
                <div class="modal-content">
                    <h3 x-text="editingPart ? 'Edit Part' : 'Create New Part'"></h3>
                    <form @submit.prevent="editingPart ? updatePart() : createPart()">
                        <div class="form-group">
                            <label>Part Number</label>
                            <input type="text" x-model="partForm.part_number" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" x-model="partForm.description" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" x-model="partForm.category" required>
                        </div>
                        <div class="form-group">
                            <label>Unit Cost ($)</label>
                            <input type="number" step="0.01" x-model="partForm.unit_cost" required>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showPartModal = false; editingPart = null;">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="loading">
                                <span x-show="!loading" x-text="editingPart ? 'Update Part' : 'Create Part'"></span>
                                <span x-show="loading" x-text="editingPart ? 'Updating...' : 'Creating...'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</body>
</html></td>
                                <td x-text="inventory.filter(i => i.part_number === part.part_number).reduce((sum, i) => sum + i.quantity, 0)"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- All Stores Panel -->
            <div x-show="showAllStoresPanel" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">All Stores</h3>
                    <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Store Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Assigned To</th>
                            <th>Total Items</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="store in allStoresView" :key="store.id">
                            <tr>
                                <td><strong x-text="store.name"></strong></td>
                                <td><span class="wo-tag" x-text="store.type"></span></td>
                                <td x-text="store.location || 'N/A'"></td>
                                <td x-text="getUserName(store.assigned_user_id)"></td>
                                <td x-text="inventory.filter(i => i.store_name === store.name).length"></td>
                                <td>
                                    <button class="btn btn-sm btn-success" 
                                            x-show="currentUser?.role === 'admin' || store.assigned_user_id === currentUser?.id || store.type === 'central'"
                                            @click="viewStoreInventory(store)">
                                        View Inventory
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Store Inventory Management Panel -->
            <div x-show="showStoreInventoryPanel" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0;" x-text="selectedStore?.name + ' Inventory'"></h3>
                        <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.9rem;" x-text="storeInventory.length + ' items in stock'"></p>
                    </div>
                    <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Work Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in storeInventory" :key="item.id">
                            <tr :class="item.quantity <= item.min_threshold ? 'low-stock' : ''">
                                <td><strong x-text="item.part_number"></strong></td>
                                <td x-text="item.description"></td>
                                <td>
                                    <strong x-text="item.quantity"></strong>
                                    <span x-show="item.quantity <= item.min_threshold">‚ö†Ô∏è</span>
                                </td>
                                <td>
                                    <span x-show="item.work_order" class="wo-tag" x-text="item.work_order"></span>
                                    <span x-show="!item.work_order" class="wo-tag">Original</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm" 
                                            x-show="canEdit(item.store_owner, item.store_type)"
                                            @click="editItem(item)">
                                        Adjust
                                    </button>
                                    <button class="btn btn-sm btn-warning" 
                                            x-show="canEdit(item.store_owner, item.store_type)"
                                            @click="transferItem(item)">
                                        Transfer
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="storeInventory.length === 0" style="padding: 2rem; text-align: center; color: #666;">
                    This store has no inventory yet.
                </div>
            </div>

            <!-- Low Stock Alerts Panel -->
            <div x-show="showLowStockPanel" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">Low Stock Alerts</h3>
                    <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Store</th>
                            <th>Current</th>
                            <th>Minimum</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in lowStockItems" :key="item.id">
                            <tr class="low-stock">
                                <td><strong x-text="item.part_number"></strong></td>
                                <td x-text="item.description"></td>
                                <td><span class="store-tag" :class="getStoreClass(item.store_type, item.store_owner)" x-text="item.store_name"></span></td>
                                <td><strong x-text="item.quantity"></strong> ‚ö†Ô∏è</td>
                                <td x-text="item.min_threshold"></td>
                                <td>
                                    <button class="btn btn-sm btn-success" 
                                            x-show="canEdit(item.store_owner, item.store_type)"
                                            @click="editItem(item)">
                                        Restock
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="lowStockItems.length === 0" style="padding: 2rem; text-align: center; color: #666;">
                    No low stock alerts. All inventory levels are good! ‚úÖ
                </div>
            </div>

            <!-- My Parts Panel -->
            <div x-show="showMyPartsPanel" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">My Parts Inventory</h3>
                    <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Store</th>
                            <th>Quantity</th>
                            <th>Work Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in myPartsView" :key="item.id">
                            <tr>
                                <td><strong x-text="item.part_number"></strong></td>
                                <td x-text="item.description"></td>
                                <td><span class="store-tag store-mine" x-text="item.store_name"></span></td>
                                <td><strong x-text="item.quantity"></strong></td>
                                <td>
                                    <span x-show="item.work_order" class="wo-tag" x-text="item.work_order"></span>
                                    <span x-show="!item.work_order" class="wo-tag">Original</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm" @click="editItem(item)">Edit</button>
                                    <button class="btn btn-sm btn-warning" @click="transferItem(item)">Transfer</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="myPartsView.length === 0" style="padding: 2rem; text-align: center; color: #666;">
                    You don't have any parts in your assigned stores yet.
                </div>
            </div>

            <!-- User Management Panel (Admin Only) -->
            <div x-show="!loading && showUsersPanel && currentUser?.role === 'admin'" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">User Management</h3>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success" 
                                @click="editingUser = null; userForm = { email: '', name: '', password: '', role: 'engineer', territory: '' }; showUserModal = true">
                            Add User
                        </button>
                        <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Territory</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="user in users" :key="user.id">
                            <tr>
                                <td x-text="user.name"></td>
                                <td x-text="user.email"></td>
                                <td>
                                    <span class="wo-tag" x-text="user.role"></span>
                                </td>
                                <td x-text="user.territory || 'N/A'"></td>
                                <td>
                                    <button class="btn btn-sm" @click="editUser(user)">Edit</button>
                                    <button class="btn btn-sm" 
                                            style="background: #dc3545; color: white;"
                                            x-show="user.id !== currentUser.id"
                                            @click="deleteUser(user.id, user.name)">Delete</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Store Management Panel (Admin Only) -->
            <div x-show="!loading && showStoresPanel && currentUser?.role === 'admin'" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                    <h3 style="margin: 0;">Store Management</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-sm" @click="downloadStoreTemplate()">Download Template</button>
                        <label class="btn btn-sm" style="cursor: pointer;">
                            Import CSV
                            <input type="file" accept=".csv" @change="importStores($event)" style="display: none;">
                        </label>
                        <button class="btn btn-success" 
                                @click="editingStore = null; storeForm = { name: '', type: 'customer_site', location: '', assigned_user_id: '' }; showStoreModal = true">
                            Add Store
                        </button>
                        <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Location</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="store in stores" :key="store.id">
                            <tr>
                                <td x-text="store.name"></td>
                                <td>
                                    <span class="wo-tag" x-text="store.type"></span>
                                </td>
                                <td x-text="store.location || 'N/A'"></td>
                                <td x-text="getUserName(store.assigned_user_id)"></td>
                                <td>
                                    <button class="btn btn-sm" @click="editStore(store)">Edit</button>
                                    <button class="btn btn-sm" 
                                            style="background: #dc3545; color: white;"
                                            @click="deleteStore(store.id, store.name)">Delete</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Parts Management Panel (Admin Only) -->
            <div x-show="!loading && showPartsPanel && currentUser?.role === 'admin'" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                    <h3 style="margin: 0;">Parts Management</h3>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-sm" @click="downloadPartTemplate()">Download Template</button>
                        <label class="btn btn-sm" style="cursor: pointer;">
                            Import CSV
                            <input type="file" accept=".csv" @change="importParts($event)" style="display: none;">
                        </label>
                        <button class="btn btn-success" 
                                @click="editingPart = null; partForm = { part_number: '', description: '', category: '', unit_cost: '' }; showPartModal = true">
                            Add Part
                        </button>
                        <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Unit Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="part in parts" :key="part.id">
                            <tr>
                                <td><strong x-text="part.part_number"></strong></td>
                                <td x-text="part.description"></td>
                                <td>
                                    <span class="wo-tag" x-text="part.category"></span>
                                </td>
                                <td x-text="part.unit_cost ? part.unit_cost.toFixed(2) : '0.00'"></td>
                                <td>
                                    <button class="btn btn-sm" @click="editPart(part)">Edit</button>
                                    <button class="btn btn-sm" 
                                            style="background: #dc3545; color: white;"
                                            @click="deletePart(part.id, part.part_number)">Delete</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Movement History Panel -->
            <div x-show="!loading && showMovementsPanel" class="inventory-table" style="margin-bottom: 1.5rem;">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0 0 1rem 0;">Movement History</h3>
                    
                    <!-- Filters -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Start Date</label>
                            <input type="date" x-model="movementFilters.startDate" style="width: 100%; padding: 0.4rem; font-size: 0.9rem;">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">End Date</label>
                            <input type="date" x-model="movementFilters.endDate" style="width: 100%; padding: 0.4rem; font-size: 0.9rem;">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Movement Type</label>
                            <select x-model="movementFilters.movementType" style="width: 100%; padding: 0.4rem; font-size: 0.9rem;">
                                <option value="">All Types</option>
                                <option value="add">Add</option>
                                <option value="remove">Remove</option>
                                <option value="transfer">Transfer</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Part</label>
                            <select x-model="movementFilters.partId" style="width: 100%; padding: 0.4rem; font-size: 0.9rem;">
                                <option value="">All Parts</option>
                                <template x-for="part in parts" :key="part.id">
                                    <option :value="part.id" x-text="part.part_number"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; display: block; margin-bottom: 0.25rem;">Store</label>
                            <select x-model="movementFilters.storeId" style="width: 100%; padding: 0.4rem; font-size: 0.9rem;">
                                <option value="">All Stores</option>
                                <template x-for="store in stores" :key="store.id">
                                    <option :value="store.id" x-text="store.name"></option>
                                </template>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-sm btn-success" @click="loadMovements()">Apply Filters</button>
                        <button class="btn btn-sm btn-success" @click="clearMovementFilters()">Clear Filters</button>
                        <button class="btn btn-sm btn-success" @click="exportMovementsCSV()">Export to CSV</button>
                        <button class="btn btn-sm" @click="closeAllPanels()">Close</button>

                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Type</th>
                            <th>Part</th>
                            <th>Qty</th>
                            <th>From</th>
                            <th>To</th>
                            <th>WO#</th>
                            <th>By</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="movement in movements" :key="movement.id">
                            <tr>
                                <td x-text="new Date(movement.created_at).toLocaleString()"></td>
                                <td>
                                    <span class="wo-tag" x-text="movement.movement_type"></span>
                                </td>
                                <td x-text="movement.part_number"></td>
                                <td><strong x-text="movement.quantity"></strong></td>
                                <td x-text="movement.from_store_name || '-'"></td>
                                <td x-text="movement.to_store_name || '-'"></td>
                                <td x-text="movement.work_order || '-'"></td>
                                <td x-text="movement.created_by_name"></td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                <div x-show="movements.length === 0" style="padding: 2rem; text-align: center; color: #666;">
                    No movement history found.
                </div>
            </div>

            <!-- Inventory Table -->
            <div x-show="!loading" class="inventory-table">
                <div style="padding: 1rem; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                    <h3 style="margin: 0 0 1rem 0;">Total Inventory</h3>
                    <!-- <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-sm" @click="closeAllPanels()">Close</button>
                    </div> -->
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Part Number</th>
                            <th>Description</th>
                            <th>Store</th>
                            <th>Quantity</th>
                            <th>Work Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="item in filteredInventory" :key="item.id">
                            <tr :class="item.quantity <= item.min_threshold ? 'low-stock' : ''">
                                <td x-text="item.part_number"></td>
                                <td x-text="item.description"></td>
                                <td>
                                    <span class="store-tag" 
                                          :class="getStoreClass(item.store_type, item.store_owner)"
                                          x-text="item.store_name">
                                    </span>
                                </td>
                                <td>
                                    <strong x-text="item.quantity"></strong>
                                    <span x-show="item.quantity <= item.min_threshold">‚ö†Ô∏è</span>
                                </td>
                                <td>
                                    <span x-show="item.work_order" 
                                          class="wo-tag" 
                                          x-text="item.work_order">
                                    </span>
                                    <span x-show="!item.work_order" class="wo-tag">Original</span>
                                </td>
                                <td>
                                    <button class="btn btn-sm" 
                                            x-show="canEdit(item.store_owner, item.store_type)"
                                            @click="editItem(item)">
                                        Edit
                                    </button>
                                    <button class="btn btn-sm btn-warning" 
                                            x-show="canEdit(item.store_owner, item.store_type)"
                                            @click="transferItem(item)">
                                        Transfer
                                    </button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
                
                <div x-show="filteredInventory.length === 0" style="padding: 2rem; text-align: center; color: #666;">
                    No inventory found matching your search criteria.
                </div>
            </div>

            <!-- ALL MODALS -->
            
            <!-- Add Stock Modal -->
            <div x-show="showAddModal" class="modal" @click.outside="showAddModal = false">
                <div class="modal-content">
                    <h3>Add Stock</h3>
                    <form @submit.prevent="addStock()">
                        <div class="form-group">
                            <label>Part</label>
                            <select x-model="addForm.part_id" required>
                                <option value="">Select Part</option>
                                <template x-for="part in parts" :key="part.id">
                                    <option :value="part.id" x-text="part.part_number + ' - ' + part.description"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Store</label>
                            <select x-model="addForm.store_id" required>
                                <option value="">Select Store</option>
                                <template x-for="store in editableStores" :key="store.id">
                                    <option :value="store.id" x-text="store.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" x-model="addForm.quantity" min="1" required>
                        </div>
                        <!-- <div class="form-group">
                            <label>Work Order (leave blank for original stock)</label>
                            <input type="text" x-model="addForm.work_order_number" placeholder="WO-2024-001">
                        </div> -->
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showAddModal = false">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="addingStock">
                                <span x-show="!addingStock">Add Stock</span>
                                <span x-show="addingStock">Adding...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Stock Modal -->
            <div x-show="showEditModal" class="modal" @click.outside="showEditModal = false">
                <div class="modal-content">
                    <h3>Edit Stock Quantity</h3>
                    <form @submit.prevent="updateStock()">
                        <div class="form-group">
                            <label>New Quantity</label>
                            <input type="number" x-model="editForm.new_quantity" min="0" required>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showEditModal = false">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="loading">
                                <span x-show="!loading">Update</span>
                                <span x-show="loading">Updating...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Transfer Stock Modal -->
            <div x-show="showTransferModal" class="modal" @click.outside="showTransferModal = false">
                <div class="modal-content">
                    <h3>Transfer Stock</h3>
                    <form @submit.prevent="transferStock()">
                        <div class="form-group">
                            <label>Destination Store</label>
                            <select x-model="transferForm.to_store_id" required>
                                <option value="">Select Store</option>
                                <template x-for="store in editableStores" :key="store.id">
                                    <option :value="store.id" x-text="store.name"></option>
                                </template>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Quantity to Transfer</label>
                            <input type="number" x-model="transferForm.quantity" min="1" required>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showTransferModal = false">Cancel</button>
                            <button type="submit" class="btn btn-warning" :disabled="loading">
                                <span x-show="!loading">Transfer</span>
                                <span x-show="loading">Transferring...</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- User Management Modal -->
            <div x-show="showUserModal" class="modal" @click.outside="showUserModal = false">
                <div class="modal-content">
                    <h3 x-text="editingUser ? 'Edit User' : 'Create New User'"></h3>
                    <form @submit.prevent="editingUser ? updateUser() : createUser()">
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" x-model="userForm.email" required :disabled="!!editingUser">
                        </div>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" x-model="userForm.name" required>
                        </div>
                        <div class="form-group">
                            <label x-text="editingUser ? 'New Password (leave blank to keep current)' : 'Password'"></label>
                            <input type="password" x-model="userForm.password" :required="!editingUser">
                        </div>
                        <div class="form-group">
                            <label>Role</label>
                            <select x-model="userForm.role" required>
                                <option value="engineer">Engineer</option>
                                <option value="admin">Admin</option>
                                <option value="manager">Manager</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Territory</label>
                            <input type="text" x-model="userForm.territory" placeholder="Optional">
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showUserModal = false; editingUser = null;">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="loading">
                                <span x-show="!loading" x-text="editingUser ? 'Update User' : 'Create User'"></span>
                                <span x-show="loading" x-text="editingUser ? 'Updating...' : 'Creating...'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Store Management Modal -->
            <div x-show="showStoreModal" class="modal" @click.outside="showStoreModal = false">
                <div class="modal-content">
                    <h3 x-text="editingStore ? 'Edit Store' : 'Create New Store'"></h3>
                    <form @submit.prevent="editingStore ? updateStore() : createStore()">
                        <div class="form-group">
                            <label>Store Name</label>
                            <input type="text" x-model="storeForm.name" required>
                        </div>
                        <div class="form-group">
                            <label>Type</label>
                            <select x-model="storeForm.type" required>
                                <option value="office">Office</option>
                                <option value="customer_site">Customer Site</option>
                                <option value="engineer">Engineer Personal</option>
                                <option value="fe_consignment">FE Consignment</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" x-model="storeForm.location" placeholder="Optional">
                        </div>
                        <div class="form-group">
                            <label>Assigned To</label>
                            <select x-model="storeForm.assigned_user_id">
                                <option value="">None</option>
                                <template x-for="user in users" :key="user.id">
                                    <option :value="user.id" x-text="user.name"></option>
                                </template>
                            </select>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showStoreModal = false; editingStore = null;">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="loading">
                                <span x-show="!loading" x-text="editingStore ? 'Update Store' : 'Create Store'"></span>
                                <span x-show="loading" x-text="editingStore ? 'Updating...' : 'Creating...'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Part Management Modal -->
            <div x-show="showPartModal" class="modal" @click.outside="showPartModal = false">
                <div class="modal-content">
                    <h3 x-text="editingPart ? 'Edit Part' : 'Create New Part'"></h3>
                    <form @submit.prevent="editingPart ? updatePart() : createPart()">
                        <div class="form-group">
                            <label>Part Number</label>
                            <input type="text" x-model="partForm.part_number" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" x-model="partForm.description" required>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <input type="text" x-model="partForm.category" required>
                        </div>
                        <div class="form-group">
                            <label>Unit Cost ($)</label>
                            <input type="number" step="0.01" x-model="partForm.unit_cost" required>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn" @click="showPartModal = false; editingPart = null;">Cancel</button>
                            <button type="submit" class="btn btn-success" :disabled="loading">
                                <span x-show="!loading" x-text="editingPart ? 'Update Part' : 'Create Part'"></span>
                                <span x-show="loading" x-text="editingPart ? 'Updating...' : 'Creating...'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
</body>
</html>